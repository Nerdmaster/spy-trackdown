// Really horrible hard-coded list of commands - this should really be generated by the app or a
// config file the app uses or something.  At the least, travel codes should be shared instead of
// doubly hard-coded.
var commandList = {
  // Movement (or lack thereof)
  "OOOO": {"text": "Skip action",                       "path": "action_skip"},
  "XOXO": {"text": "Travel by Sports Car (red)",        "path": "action_travel", "action": "0"},
  "XOOO": {"text": "Travel by Helicopter (blue)",       "path": "action_travel", "action": "1"},
  "OXOX": {"text": "Travel by Motorcycle (green)",      "path": "action_travel", "action": "2"},
  "OXXX": {"text": "Travel by Jet (yellow)",            "path": "action_travel", "action": "3"},

  // TODO: Covert actions
};

// Returns the currently entered command on the phone
function currentCommand() {
  return $("#phone-display").data("command");
}

// Displays current command in phone "terminal"
function displayPhoneCommand() {
  $("#phone-display").html(currentCommand() + "_");
}

// Resets the phone command to a blank string
function resetCommand() {
  $("#phone-display").data("command", "");
  displayPhoneCommand();
}

// Processes button presses, adding to the command string and showing a confirmation button
// if the string maps to a full command
function addToCommand(val) {
  $("#phone-display").data("command", currentCommand() + val);
  displayPhoneCommand();
}

// Shows a modal dialog when a command is entered to get confirmation from user
function showConfirm(actionData) {
  if (!actionData) {
    alert("Invalid command entered.");
    return;
  }

  var formAction = $("#confirm-command form").attr("action");
  var validURL = formAction.replace("%PATH%", actionData.path);
  $("#confirm-command form").attr("action", validURL);

  $("#confirm-command-label").html("Are you sure?")
  $("#confirm-command .modal-body").html("Confirm: " + actionData.text);
  $("#confirm-command-action").val(actionData.action);
  $("#confirm-command").modal();
}

// Does lookup for commands, and if the command is valid, asks for confirmation
function checkCommand() {
  var command = currentCommand();
  if (command.length == 4) {
    resetCommand();
    showConfirm(commandList[command]);
  }
}

$(function() {
  // Attach listeners to phone buttons
  $("#phone .phone-button.command button").on("click", function() {
    addToCommand($(this).data("value"));
    checkCommand();
  });

  $("#phone .phone-button.reset button").on("click", function() {
    resetCommand();
  });
});
